#!/usr/bin/env ruby

require 'netrc'
require 'octokit'
require 'pinboard'
require 'pinboard-fixup-github-titles'
include PinboardFixupGithubTitles

if pinboard_api_token = ENV['PINBOARD_API_TOKEN']
  pinboard = Pinboard::Client.new(:token => pinboard_api_token)
  STDERR.puts "Logged on to Pinboard as #{pinboard_api_token.split(':').first}"
else
  STDERR.puts "Pinboard API token missing."
  exit 1
end

# Authentication is required due to Github's API rate limit
begin
  github = Octokit::Client.new(GithubCredentialsResolver.new.resolve)
rescue GithubCredentialsResolver::MissingCredentials
  STDERR.puts $!.message
  exit 2
end

if github.login
  STDERR.puts "Logged on to github.com as #{github.user.login}"
else
  STDERR.puts 'Login to github failed. Check your credentials.'
  exit 3
end

posts = pinboard.posts(meta: true)
STDERR.puts "Checking #{posts.size} bookmarks:"
updated = 0

posts.each do |post|
  begin
    next unless md = %r{//github.com/([^/]+/[^/]+)}.match(post.href)

    repo = github.repo(md[1])
    canonical_description = "#{repo.name}: #{repo.description}"

    if post.description == canonical_description
      STDOUT.puts "✓ #{canonical_description}"
      next
    end

    STDERR.puts "Updating '#{post.description}' => '#{canonical_description}'"

    tags = post.tag
    tags << 'github' unless tags.include?('github')
    tags << repo.language

    pinboard.add(
      url: post.href,
      description: canonical_description,
      extended: post.extended,
      tags: tags,
      replace: true,
      shared: true,
      toread: false,
    )

    updated += 1
  rescue
    STDOUT.puts "⨯ #{post.href} #{$!.message}"
  end
end

STDERR.puts "Updated #{updated} of #{posts.size} bookmarks."
